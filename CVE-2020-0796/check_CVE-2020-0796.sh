#!/bin/bash
if [ $# -eq 0 ]
then
        echo $'Usage:\n\tcheck_CVE-2020-0796.sh FILENAME'
        echo -e "\nWhere FILENAME is a file containing one IP per line"
        exit 1
fi

echo "Checking if there's SMB v3.11 in" $1 "..."
nmap -p445 --script smb-protocols -Pn -n -iL $1 | grep -P '\d+\.\d+\.\d+\.\d+|^\|.\s+3.11' | tr '\n' ' ' | sed 's/Nmap scan report for/@/g' | tr "@" "\n" | grep 3.11 | tr '|' ' ' | tr '_' ' ' | grep -oP '\d+\.\d+\.\d+\.\d+'

if [[ $? != 0 ]]; then
        echo "There's no SMB v3.11"
else
        echo "You can block the exploitation of the vulnerability using the following PowerShell command on the impacted servers:"
        echo -e "\t"'Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\LanmanServer\Parameters" DisableCompression -Type DWORD -Value 1 â€“Force'
fi
